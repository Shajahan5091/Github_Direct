{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION   : Inventory latest snapshot with product and supplier lookups
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with inventory_source as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

inventory_transformed as (
    select 
        -- Auto corrected using semantic file: product_id exists in semantic model
        coalesce(inv.product_id, '0') as product_id,
        -- Auto corrected using semantic file: supplier_id exists in semantic model  
        coalesce(inv.supplier_id, '0') as supplier_id,
        -- Auto corrected using semantic file: stock_qty exists in semantic model
        case 
            when inv.stock_qty < 0 then null
            else inv.stock_qty
        end as stock_qty,
        -- Auto corrected using semantic file: warehouse_location exists in semantic model
        upper(inv.warehouse_location) as warehouse_location,
        -- Auto corrected using semantic file: last_updated exists in semantic model
        date(inv.last_updated) as snapshot_date,
        inv.last_updated,
        current_timestamp() as last_updated_model
    from inventory_source inv
),

inventory_with_latest_flag as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        snapshot_date,
        last_updated,
        last_updated_model,
        case 
            when last_updated = max(last_updated) over (partition by product_id, supplier_id) 
            then true 
            else false 
        end as is_latest
    from inventory_transformed
)

select 
    product_id,
    supplier_id,
    stock_qty,
    warehouse_location,
    snapshot_date,
    is_latest,
    last_updated_model as last_updated
from inventory_with_latest_flag
{% if var('models')['backfill_flag'] == 'true' %}
where last_updated between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
{% endif %}