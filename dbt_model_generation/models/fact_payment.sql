{#
------------------------------------------------------------------------
MODEL NAME    : fact_payment
TARGET TABLE  : BSL_MA.DWH_MA.FACT_PAYMENT
SOURCE TABLES : BSL_RAW.DWH_RAW.PAYMENTS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for payment transactions with 
                payment methods standardized and full payment status calculated
PREREQUISITES : fact_order model must exist for order lookup
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-27
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'incremental',
    unique_key = 'payment_id',
    incremental_strategy = 'merge'
) }}

WITH source_payments AS (
    SELECT
        payment_id,
        order_id,
        payment_date,
        payment_method,
        amount,
        inserted_at
    FROM {{ source('dwh_raw', 'payments') }}
    {% if var('backfill_flag') == 'true' %}
        WHERE inserted_at BETWEEN '{{ var("backfill_start_date") }}' AND '{{ var("backfill_end_date") }}'
    {% else %}
        {% if is_incremental() %}
            WHERE inserted_at > COALESCE(
                (SELECT MAX(last_updated) FROM BSL_MA.DWH_MA.fact_payment), 
                TO_DATE('0001-01-01')
            )
        {% endif %}
    {% endif %}
),

source_orders AS (
    SELECT
        order_id,
        total_amount
    FROM {{ source('dwh_raw', 'orders') }}
),

-- Auto corrected using semantic file: Changed payment_date from TIMESTAMP to DATE conversion
payment_transformations AS (
    SELECT
        payments.payment_id,
        payments.order_id,
        DATE(payments.payment_date) AS payment_date, -- Convert timestamp to date
        CASE 
            WHEN UPPER(payments.payment_method) IN ('CREDIT CARD', 'DEBIT CARD') THEN 'CARD'
            WHEN UPPER(payments.payment_method) = 'PAYPAL' THEN 'UPI'
            WHEN UPPER(payments.payment_method) IN ('CARD', 'UPI', 'COD', 'NETBANKING') THEN UPPER(payments.payment_method)
            ELSE 'CARD' -- If not in list set to 'CARD'
        END AS payment_method,
        CASE 
            WHEN payments.amount < 0 THEN NULL -- If negative set to null and log
            ELSE payments.amount
        END AS amount,
        payments.inserted_at
    FROM source_payments AS payments
),

-- Join with orders to check if order exists and calculate full payment status
payments_with_order_check AS (
    SELECT
        payments.payment_id,
        payments.order_id,
        payments.payment_date,
        payments.payment_method,
        payments.amount,
        payments.inserted_at,
        orders.total_amount AS order_total_amount
    FROM payment_transformations AS payments
    INNER JOIN source_orders AS orders
        ON payments.order_id = orders.order_id -- Skip payment if order not present
),

-- Calculate payment aggregation per order to determine if fully applied
order_payment_totals AS (
    SELECT
        order_id,
        SUM(COALESCE(amount, 0)) AS total_payments_for_order
    FROM payments_with_order_check
    GROUP BY order_id
),

final_payments AS (
    SELECT
        payments.payment_id,
        payments.order_id,
        payments.payment_date,
        payments.payment_method,
        payments.amount,
        CASE 
            WHEN payments.order_total_amount IS NULL THEN FALSE -- If order total null set false
            WHEN order_totals.total_payments_for_order >= payments.order_total_amount THEN TRUE
            ELSE FALSE
        END AS is_fully_applied,
        payments.inserted_at AS last_updated
    FROM payments_with_order_check AS payments
    LEFT JOIN order_payment_totals AS order_totals
        ON payments.order_id = order_totals.order_id
)

SELECT * FROM final_payments