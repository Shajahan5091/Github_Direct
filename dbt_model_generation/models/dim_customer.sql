{#
------------------------------------------------------------------------
MODEL NAME    : dim_customer
TARGET TABLE  : BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES : BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : Customer dimension table with customer details and 
                derived spending tier based on order history
PREREQUISITES : Source tables CUSTOMERS and ORDERS must be available
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-21
------------------------------------------------------------------------
#}

{{ config(materialized='view') }}

with customers_base as (
    select
        customer_id,
        trim(upper(first_name)) as first_name, -- auto corrected using semantic file
        trim(upper(last_name)) as last_name, -- auto corrected using semantic file
        case 
            when regexp_like(lower(email), '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$')
            then lower(email)
            else null
        end as email,
        case 
            when inserted_at is null 
            then current_date()
            else date(inserted_at)
        end as customer_since_date,
        coalesce(inserted_at, current_timestamp()) as last_updated
    from {{ source('dwh_raw', 'customers') }}
),

customer_orders as (
    select
        orders.customer_id,
        sum(orders.total_amount) as total_order_amount_365_days
    from {{ source('dwh_raw', 'orders') }} as orders
    where orders.order_date >= dateadd('day', -365, current_date())
    group by orders.customer_id
),

final as (
    select
        customers_base.customer_id,
        customers_base.first_name,
        customers_base.last_name,
        customers_base.email,
        customers_base.customer_since_date,
        case
            when coalesce(customer_orders.total_order_amount_365_days, 0) >= 1000 then 'Gold'
            when coalesce(customer_orders.total_order_amount_365_days, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier,
        customers_base.last_updated
    from customers_base
    left join customer_orders
        on customers_base.customer_id = customer_orders.customer_id
)

select * from final