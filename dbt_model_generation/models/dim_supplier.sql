{#
------------------------------------------------------------------------
MODEL NAME    : dim_supplier
TARGET TABLE  : BSL_MA.DWH_MA.DIM_SUPPLIER
SOURCE TABLES : BSL_RAW.DWH_RAW.SUPPLIERS
DESCRIPTION   : This model creates a dimension table for suppliers with 
                standardized data transformations including name formatting,
                email validation, and country standardization
PREREQUISITES : Source table BSL_RAW.DWH_RAW.SUPPLIERS must exist
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-25
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'table',
    alias = 'dim_supplier'
) }}

WITH source_data AS (
    SELECT
        suppliers.supplier_id,
        suppliers.supplier_name,
        suppliers.contact_email,
        suppliers.country,
        suppliers.active_flag,
        suppliers.inserted_at -- auto corrected using semantic file
    FROM {{ source('dwh_raw', 'suppliers') }}
),

transformed AS (
    SELECT
        suppliers.supplier_id,
        INITCAP(TRIM(suppliers.supplier_name)) AS supplier_name,
        CASE 
            WHEN REGEXP_LIKE(LOWER(suppliers.contact_email), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
            THEN LOWER(suppliers.contact_email)
            ELSE NULL
        END AS contact_email,
        UPPER(suppliers.country) AS country,
        COALESCE(suppliers.active_flag, FALSE) AS is_active,
        suppliers.inserted_at AS last_updated
    FROM source_data AS suppliers
)

SELECT * FROM transformed