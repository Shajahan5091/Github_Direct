{#
------------------------------------------------------------------------
MODEL NAME    : fact_shipment
TARGET TABLE  : BSL_MA.DWH_MA.FACT_SHIPMENT
SOURCE TABLES : BSL_RAW.DWH_RAW.SHIPMENTS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for shipments by combining
                shipment data with order information to calculate shipping
                metrics and provide comprehensive shipment analytics.
PREREQUISITES : Orders data must be available in the fact_order model
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-25
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'incremental',
    alias = 'fact_shipment'
) }}

WITH source_shipments AS (
    SELECT
        shipment_id,
        order_id,
        shipped_date,
        carrier,
        tracking_number,
        inserted_at
    FROM {{ source('dwh_raw', 'shipments') }}
    {% if var('models')['backfill_flag'] == 'true' %}
        WHERE inserted_at BETWEEN '{{ var("models")["backfill_start_date"] }}' AND '{{ var("models")["backfill_end_date"] }}'
    {% else %}
        {% if is_incremental() %}
            WHERE inserted_at > (SELECT MAX(inserted_at) FROM {{ this }})
        {% endif %}
    {% endif %}
),

source_orders AS (
    SELECT
        order_id,
        order_date
    FROM {{ source('dwh_raw', 'orders') }}
),

shipments_with_orders AS (
    SELECT
        shipments.shipment_id,
        shipments.order_id,
        shipments.shipped_date,
        shipments.carrier,
        shipments.tracking_number,
        shipments.inserted_at,
        orders.order_date
    FROM source_shipments AS shipments
    LEFT JOIN source_orders AS orders
        ON shipments.order_id = orders.order_id
    WHERE orders.order_id IS NOT NULL  -- Skip if order missing
),

transformed AS (
    SELECT
        shipment_id,
        order_id,
        shipped_date::DATE AS shipped_date,  -- Convert timestamp to date
        GREATEST(0, DATEDIFF('day', order_date, shipped_date)) AS days_to_ship,  -- Date diff with floor at 0
        UPPER(carrier) AS carrier,  -- Uppercase carrier
        tracking_number,
        inserted_at AS last_updated,  -- Direct mapping
        CURRENT_TIMESTAMP() AS last_updated  -- Auto corrected using semantic file - added for incremental materialization
    FROM shipments_with_orders
)

SELECT * FROM transformed