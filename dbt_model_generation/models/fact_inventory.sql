{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION   : Inventory latest snapshot with product and supplier lookups
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-21
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with inventory_base as (
    select
        inventory.product_id,
        inventory.supplier_id,
        inventory.stock_qty,
        inventory.warehouse_location,
        inventory.last_updated,
        inventory.inserted_at -- auto corrected using semantic file
    from {{ source('dwh_raw', 'inventory') }} as inventory
    {% if var('models')['backfill_flag'] == 'true' %}
        where inventory.inserted_at between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
    {% else %}
        {% if is_incremental() %}
            where inventory.inserted_at > (select max(inserted_at) from {{ this }})
        {% endif %}
    {% endif %}
),

inventory_transformed as (
    select
        -- Product ID lookup with unknown handling
        coalesce(inventory_base.product_id, '0') as product_id,
        
        -- Supplier ID lookup with unknown handling  
        coalesce(inventory_base.supplier_id, '0') as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when inventory_base.stock_qty < 0 then null
            else inventory_base.stock_qty
        end as stock_qty,
        
        -- Warehouse location uppercase transformation
        upper(inventory_base.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date for snapshot
        date(inventory_base.last_updated) as snapshot_date,
        
        -- Original timestamp fields
        inventory_base.last_updated,
        inventory_base.inserted_at
    from inventory_base
),

inventory_with_latest_flag as (
    select
        inventory_transformed.product_id,
        inventory_transformed.supplier_id,
        inventory_transformed.stock_qty,
        inventory_transformed.warehouse_location,
        inventory_transformed.snapshot_date,
        
        -- Flag latest record per product_id + supplier_id combination
        case 
            when inventory_transformed.last_updated = max(inventory_transformed.last_updated) 
                over (partition by inventory_transformed.product_id, inventory_transformed.supplier_id)
            then true
            else false
        end as is_latest,
        
        inventory_transformed.inserted_at as last_updated
    from inventory_transformed
)

select
    final_inventory.product_id,
    final_inventory.supplier_id,
    final_inventory.stock_qty,
    final_inventory.warehouse_location,
    final_inventory.snapshot_date,
    final_inventory.is_latest,
    final_inventory.last_updated
from inventory_with_latest_flag as final_inventory