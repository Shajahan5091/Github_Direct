{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : bsl_ma.dwh_ma.fact_inventory
SOURCE TABLES : bsl_raw.dwh_raw.inventory
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, data quality checks and latest record 
                flagging per product-supplier combination
PREREQUISITES : dim_product and dim_supplier tables must exist
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2025-11-19
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_inventory as (
    select * 
    from {{ source('dwh_raw', 'inventory') }}
),

inventory_with_lookups as (
    select
        -- Product lookup with unknown handling
        coalesce(dim_prod.product_id, '0') as product_id,
        
        -- Supplier lookup with unknown handling  
        coalesce(dim_supp.supplier_id, '0') as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when src_inv.stock_qty < 0 then null
            else src_inv.stock_qty
        end as stock_qty,
        
        -- Warehouse location uppercase transformation
        upper(src_inv.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        date(src_inv.last_updated) as snapshot_date,
        
        -- Keep original timestamp for latest record calculation
        src_inv.last_updated as source_last_updated
        
    from source_inventory as src_inv
    
    left join {{ ref('dim_product') }} as dim_prod
        on src_inv.product_id = dim_prod.product_id
        
    left join {{ ref('dim_supplier') }} as dim_supp  
        on src_inv.supplier_id = dim_supp.supplier_id
),

inventory_with_latest_flag as (
    select
        inv_lookup.product_id,
        inv_lookup.supplier_id,
        inv_lookup.stock_qty,
        inv_lookup.warehouse_location,
        inv_lookup.snapshot_date,
        
        -- Flag latest record per product_id + supplier_id combination
        case 
            when inv_lookup.source_last_updated = max(inv_lookup.source_last_updated) 
                over (partition by inv_lookup.product_id, inv_lookup.supplier_id)
            then true
            else false
        end as is_latest
        
    from inventory_with_lookups as inv_lookup
)

select
    final_inv.product_id,
    final_inv.supplier_id,
    final_inv.stock_qty,
    final_inv.warehouse_location,
    final_inv.snapshot_date,
    final_inv.is_latest
    
from inventory_with_latest_flag as final_inv