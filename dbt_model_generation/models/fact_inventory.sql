{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : bsl_ma.dwh_ma.fact_inventory
SOURCE TABLES : bsl_raw.dwh_raw.inventory
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, stock quantities, and warehouse locations
PREREQUISITES : dim_product and dim_supplier tables must exist
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2025-11-19
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_inventory as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

inventory_with_flags as (
    select 
        source_inventory.product_id,
        source_inventory.supplier_id,
        source_inventory.stock_qty,
        source_inventory.warehouse_location,
        source_inventory.last_updated,
        row_number() over (
            partition by source_inventory.product_id, source_inventory.supplier_id 
            order by source_inventory.last_updated desc
        ) as row_num
    from source_inventory
),

final as (
    select 
        -- Product ID with lookup handling
        coalesce(
            case 
                when dim_product.product_id is not null then inventory_with_flags.product_id
                else '0'
            end, 
            '0'
        ) as product_id,
        
        -- Supplier ID with lookup handling
        coalesce(
            case 
                when dim_supplier.supplier_id is not null then inventory_with_flags.supplier_id
                else '0'
            end,
            '0'
        ) as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when inventory_with_flags.stock_qty < 0 then null
            else inventory_with_flags.stock_qty
        end as stock_qty,
        
        -- Warehouse location in uppercase
        upper(inventory_with_flags.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        date(inventory_with_flags.last_updated) as snapshot_date,
        
        -- Flag for latest record
        case 
            when inventory_with_flags.row_num = 1 then true
            else false
        end as is_latest
        
    from inventory_with_flags
    left join {{ ref('dim_product') }} as dim_product
        on inventory_with_flags.product_id = dim_product.product_id
    left join {{ ref('dim_supplier') }} as dim_supplier
        on inventory_with_flags.supplier_id = dim_supplier.supplier_id
)

select * from final