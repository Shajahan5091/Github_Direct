{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, stock quantities, and latest record flags
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_inventory as (
    select 
        inventory.PRODUCT_ID,
        inventory.SUPPLIER_ID,
        inventory.STOCK_QTY,
        inventory.WAREHOUSE_LOCATION,
        inventory.LAST_UPDATED
    from {{ source('dwh_raw', 'inventory') }} as inventory
),

-- Auto corrected using semantic file: Added product dimension lookup
product_lookup as (
    select 
        source_inventory.PRODUCT_ID,
        source_inventory.SUPPLIER_ID,
        source_inventory.STOCK_QTY,
        source_inventory.WAREHOUSE_LOCATION,
        source_inventory.LAST_UPDATED,
        coalesce(dim_product.PRODUCT_ID, '0') as validated_product_id
    from source_inventory
    left join {{ ref('dim_product') }} as dim_product
        on source_inventory.PRODUCT_ID = dim_product.PRODUCT_ID
),

-- Auto corrected using semantic file: Added supplier dimension lookup
supplier_lookup as (
    select 
        product_lookup.validated_product_id as product_id,
        product_lookup.SUPPLIER_ID,
        product_lookup.STOCK_QTY,
        product_lookup.WAREHOUSE_LOCATION,
        product_lookup.LAST_UPDATED,
        coalesce(dim_supplier.SUPPLIER_ID, '0') as validated_supplier_id
    from product_lookup
    left join {{ ref('dim_supplier') }} as dim_supplier
        on product_lookup.SUPPLIER_ID = dim_supplier.SUPPLIER_ID
),

-- Calculate latest record flag per product_id and supplier_id combination
latest_records as (
    select 
        supplier_lookup.product_id,
        supplier_lookup.validated_supplier_id as supplier_id,
        case 
            when supplier_lookup.STOCK_QTY < 0 then null
            else supplier_lookup.STOCK_QTY
        end as stock_qty,
        upper(supplier_lookup.WAREHOUSE_LOCATION) as warehouse_location,
        supplier_lookup.LAST_UPDATED::date as snapshot_date,
        case 
            when supplier_lookup.LAST_UPDATED = max(supplier_lookup.LAST_UPDATED) over (
                partition by supplier_lookup.product_id, supplier_lookup.validated_supplier_id
            ) then true
            else false
        end as is_latest,
        current_timestamp() as last_updated
    from supplier_lookup
)

select 
    latest_records.product_id,
    latest_records.supplier_id,
    latest_records.stock_qty,
    latest_records.warehouse_location,
    latest_records.snapshot_date,
    latest_records.is_latest,
    latest_records.last_updated
from latest_records
{% if var('models')['backfill_flag'] == 'true' %}
where last_updated between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
{% endif %}