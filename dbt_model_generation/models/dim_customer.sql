{#
------------------------------------------------------------------------
MODEL NAME    : dim_customer
TARGET TABLE  : BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES : BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : Customer dimension table with customer details and 
                derived spending tier based on order history
PREREQUISITES : Source tables CUSTOMERS and ORDERS must be available
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

{{ config(materialized='view') }}

with source_customers as (
    select 
        customer_id,
        first_name, -- auto corrected using semantic file
        last_name, -- auto corrected using semantic file
        email,
        inserted_at
    from {{ source('dwh_raw', 'customers') }}
),

source_orders as (
    select 
        customer_id,
        total_amount,
        order_date
    from {{ source('dwh_raw', 'orders') }}
),

customer_spending as (
    select 
        orders.customer_id,
        sum(orders.total_amount) as total_spending_365_days
    from source_orders as orders
    where orders.order_date >= dateadd('day', -365, current_date())
    group by orders.customer_id
),

customer_tier_logic as (
    select 
        customers.customer_id,
        trim(upper(customers.first_name)) as first_name,
        trim(upper(customers.last_name)) as last_name,
        case 
            when regexp_like(lower(trim(customers.email)), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
            then lower(trim(customers.email))
            else null
        end as email,
        coalesce(customers.inserted_at::date, current_date()) as customer_since_date,
        case 
            when coalesce(spending.total_spending_365_days, 0) >= 1000 then 'Gold'
            when coalesce(spending.total_spending_365_days, 0) >= 500 then 'Silver'
            else 'Bronze'
        end as customer_tier
    from source_customers as customers
    left join customer_spending as spending
        on customers.customer_id = spending.customer_id
)

select 
    customer_id,
    first_name,
    last_name,
    email,
    customer_since_date,
    customer_tier
from customer_tier_logic