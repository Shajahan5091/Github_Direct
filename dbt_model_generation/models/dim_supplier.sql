{#
------------------------------------------------------------------------
MODEL NAME    : dim_supplier
TARGET TABLE  : BSL_MA.DWH_MA.DIM_SUPPLIER
SOURCE TABLES : BSL_RAW.DWH_RAW.SUPPLIERS
DESCRIPTION   : Dimension table for suppliers containing supplier information
                with data quality transformations and standardization
PREREQUISITES : Source table SUPPLIERS must exist in BSL_RAW.DWH_RAW schema
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-27
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'table',
    alias = 'dim_supplier'
) }}

WITH source_data AS (
    SELECT
        supplier_id,
        supplier_name,
        contact_email,
        country,
        active_flag,
        inserted_at
    FROM {{ source('dwh_raw', 'suppliers') }}
),

transformed AS (
    SELECT
        supplier_id,
        INITCAP(TRIM(supplier_name)) AS supplier_name, -- Trim and title-case
        CASE 
            WHEN REGEXP_LIKE(LOWER(TRIM(contact_email)), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$') 
            THEN LOWER(TRIM(contact_email))
            ELSE NULL -- auto corrected using semantic file: If invalid email pattern set null
        END AS contact_email,
        UPPER(country) AS country, -- Uppercase country
        COALESCE(active_flag, FALSE) AS is_active, -- auto corrected using semantic file: If null default false
        inserted_at AS last_updated -- Direct mapping
    FROM source_data
)

SELECT * FROM transformed