{#
------------------------------------------------------------------------
MODEL NAME    : dim_customer
TARGET TABLE  : BSL_MA.DWH_MA.DIM_CUSTOMER
SOURCE TABLES : BSL_RAW.DWH_RAW.CUSTOMERS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : Customer dimension table with derived customer tier based on spending
PREREQUISITES : Source tables CUSTOMERS and ORDERS must be available
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-25
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'view',
    alias = 'dim_customer'
) }}

WITH customers_source AS (
    SELECT
        customer_id,
        first_name, -- auto corrected using semantic file
        last_name, -- auto corrected using semantic file
        email,
        created_at,
        inserted_at
    FROM {{ source('dwh_raw', 'customers') }}
    {% if var('models')['backfill_flag'] == 'true' %}
        WHERE inserted_at BETWEEN 'var("models")["backfill_start_date"]' AND 'var("models")["backfill_end_date"]'
    {% else %}
        {% if is_incremental() %}
            WHERE inserted_at > (SELECT MAX(inserted_at) FROM {{ this }})
        {% endif %}
    {% endif %}
),

orders_source AS (
    SELECT
        customer_id,
        total_amount,
        order_date
    FROM {{ source('dwh_raw', 'orders') }}
    WHERE order_date >= CURRENT_DATE - 365
),

customer_spending AS (
    SELECT
        orders_source.customer_id,
        SUM(orders_source.total_amount) AS total_spending_365_days
    FROM orders_source
    GROUP BY orders_source.customer_id
),

transformed AS (
    SELECT
        customers_source.customer_id,
        UPPER(TRIM(customers_source.first_name)) AS first_name, -- Trim and Upper-case first name
        UPPER(TRIM(customers_source.last_name)) AS last_name, -- Trim and Upper-case last name
        CASE 
            WHEN customers_source.email REGEXP '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$' 
            THEN LOWER(customers_source.email) 
            ELSE NULL 
        END AS email, -- Lowercase email for consistency, set to NULL if invalid pattern
        CASE 
            WHEN customers_source.created_at IS NULL 
            THEN CURRENT_DATE 
            ELSE customers_source.created_at::DATE 
        END AS customer_since_date, -- Convert timestamp to date, default to current_date if null
        CASE 
            WHEN COALESCE(customer_spending.total_spending_365_days, 0) >= 1000 THEN 'Gold'
            WHEN COALESCE(customer_spending.total_spending_365_days, 0) BETWEEN 500 AND 999.99 THEN 'Silver'
            ELSE 'Bronze'
        END AS customer_tier, -- Derive spending tier based on total_amount in last 365 days
        customers_source.inserted_at AS last_updated
    FROM customers_source
    LEFT JOIN customer_spending 
        ON customers_source.customer_id = customer_spending.customer_id
)

SELECT * FROM transformed