{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : bsl_ma.dwh_ma.fact_inventory
SOURCE TABLES : bsl_raw.dwh_raw.inventory
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, data quality checks, and latest 
                record flagging
PREREQUISITES : dim_product and dim_supplier tables must exist
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2025-11-17
------------------------------------------------------------------------
#}

with source_inventory as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

product_lookup as (
    select 
        product_id
    from {{ ref('dim_product') }}
),

supplier_lookup as (
    select 
        supplier_id
    from {{ ref('dim_supplier') }}
),

inventory_with_lookups as (
    select 
        coalesce(product_lookup.product_id, '0') as product_id,
        coalesce(supplier_lookup.supplier_id, '0') as supplier_id,
        case 
            when source_inventory.stock_qty < 0 then null
            else source_inventory.stock_qty
        end as stock_qty,
        upper(source_inventory.warehouse_location) as warehouse_location,
        date(source_inventory.last_updated) as snapshot_date,
        source_inventory.last_updated as last_updated_timestamp
    from source_inventory
    left join product_lookup 
        on source_inventory.product_id = product_lookup.product_id
    left join supplier_lookup 
        on source_inventory.supplier_id = supplier_lookup.supplier_id
),

latest_records as (
    select 
        product_id,
        supplier_id,
        max(last_updated_timestamp) as max_last_updated
    from inventory_with_lookups
    group by product_id, supplier_id
),

final_inventory as (
    select 
        inventory_with_lookups.product_id,
        inventory_with_lookups.supplier_id,
        inventory_with_lookups.stock_qty,
        inventory_with_lookups.warehouse_location,
        inventory_with_lookups.snapshot_date,
        case 
            when inventory_with_lookups.last_updated_timestamp = latest_records.max_last_updated 
            then true
            else false
        end as is_latest
    from inventory_with_lookups
    inner join latest_records
        on inventory_with_lookups.product_id = latest_records.product_id
        and inventory_with_lookups.supplier_id = latest_records.supplier_id
)

select 
    product_id,
    supplier_id,
    stock_qty,
    warehouse_location,
    snapshot_date,
    is_latest
from final_inventory