{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : bsl_ma.dwh_ma.fact_inventory
SOURCE TABLES : bsl_raw.dwh_raw.inventory
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, data quality checks and latest record 
                flagging
PREREQUISITES : dim_product and dim_supplier tables must exist
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2024-12-19 (IST)
------------------------------------------------------------------------
#}

with source_inventory as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

product_lookup as (
    select 
        product_id
    from {{ ref('dim_product') }}
),

supplier_lookup as (
    select 
        supplier_id  
    from {{ ref('dim_supplier') }}
),

inventory_with_flags as (
    select
        src.product_id,
        src.supplier_id,
        src.stock_qty,
        src.warehouse_location,
        src.last_updated,
        row_number() over (
            partition by src.product_id, src.supplier_id 
            order by src.last_updated desc
        ) as row_num
    from source_inventory src
),

final_inventory as (
    select
        -- Product ID with lookup and default handling
        coalesce(prod.product_id, inv.product_id, '0') as product_id,
        
        -- Supplier ID with lookup and default handling  
        coalesce(supp.supplier_id, inv.supplier_id, '0') as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when inv.stock_qty < 0 then null
            else inv.stock_qty
        end as stock_qty,
        
        -- Warehouse location in uppercase
        upper(inv.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date
        inv.last_updated::date as snapshot_date,
        
        -- Flag for latest record per product and supplier
        case when inv.row_num = 1 then true else false end as is_latest
        
    from inventory_with_flags inv
    left join product_lookup prod 
        on inv.product_id = prod.product_id
    left join supplier_lookup supp 
        on inv.supplier_id = supp.supplier_id
)

select 
    product_id,
    supplier_id, 
    stock_qty,
    warehouse_location,
    snapshot_date,
    is_latest
from final_inventory