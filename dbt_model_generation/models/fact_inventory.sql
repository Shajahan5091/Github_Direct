{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY, BSL_RAW.DWH_RAW.PRODUCTS, BSL_RAW.DWH_RAW.SUPPLIERS
DESCRIPTION   : Inventory latest snapshot fact table with product and supplier lookups
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-25
------------------------------------------------------------------------
#}

{{ config(
    materialized = 'table',
    alias = 'fact_inventory'
) }}

WITH source_inventory AS (
    SELECT
        inventory.product_id,
        inventory.supplier_id,
        inventory.stock_qty,
        inventory.warehouse_location,
        inventory.last_updated,
        inventory.inserted_at
    FROM {{ source('dwh_raw', 'inventory') }} AS inventory
    {% if var('models')['backfill_flag'] == 'true' %}
        WHERE inventory.inserted_at BETWEEN '{{ var("models")["backfill_start_date"] }}' AND '{{ var("models")["backfill_end_date"] }}'
    {% else %}
        {% if is_incremental() %}
            WHERE inventory.inserted_at > (SELECT MAX(inserted_at) FROM {{ this }})
        {% endif %}
    {% endif %}
),

product_lookup AS (
    SELECT
        products.product_id
    FROM {{ source('dwh_raw', 'products') }} AS products
),

supplier_lookup AS (
    SELECT
        suppliers.supplier_id
    FROM {{ source('dwh_raw', 'suppliers') }} AS suppliers
),

inventory_with_lookups AS (
    SELECT
        COALESCE(source_inventory.product_id, '0') AS product_id, -- auto corrected using semantic file: If missing set to 0 (unknown) and retain for audit
        COALESCE(source_inventory.supplier_id, '0') AS supplier_id, -- auto corrected using semantic file: If supplier missing set to 0 (unknown)
        CASE 
            WHEN source_inventory.stock_qty < 0 THEN NULL 
            ELSE source_inventory.stock_qty 
        END AS stock_qty, -- If negative set to null and flag
        UPPER(source_inventory.warehouse_location) AS warehouse_location,
        DATE(source_inventory.last_updated) AS snapshot_date,
        source_inventory.inserted_at AS last_updated
    FROM source_inventory
    LEFT JOIN product_lookup ON source_inventory.product_id = product_lookup.product_id
    LEFT JOIN supplier_lookup ON source_inventory.supplier_id = supplier_lookup.supplier_id
),

inventory_with_latest_flag AS (
    SELECT
        inventory_with_lookups.product_id,
        inventory_with_lookups.supplier_id,
        inventory_with_lookups.stock_qty,
        inventory_with_lookups.warehouse_location,
        inventory_with_lookups.snapshot_date,
        inventory_with_lookups.last_updated,
        CASE 
            WHEN ROW_NUMBER() OVER (
                PARTITION BY inventory_with_lookups.product_id, inventory_with_lookups.supplier_id 
                ORDER BY inventory_with_lookups.last_updated DESC
            ) = 1 
            THEN TRUE 
            ELSE FALSE 
        END AS is_latest
    FROM inventory_with_lookups
)

SELECT * FROM inventory_with_latest_flag