{#
------------------------------------------------------------------------
MODEL NAME    : fact_payment
TARGET TABLE  : bsl_ma.dwh_ma.fact_payment
SOURCE TABLES : bsl_raw.dwh_raw.payments, bsl_raw.dwh_raw.orders
DESCRIPTION   : This model creates the fact payment table by processing 
                payment data with order validation and payment method 
                standardization. Includes payment aggregation logic to 
                determine if payments fully cover order amounts.
PREREQUISITES : Source tables payments and orders must be available
PARAMETER     : Incremental model based on payment_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-17
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='payment_id'
) }}

with source_payments as (
    select 
        payment_id,
        order_id,
        payment_date,
        payment_method,
        amount
    from {{ source('dwh_raw', 'payments') }}
    {% if is_incremental() %}
        where payment_date::date > (select coalesce(max(payment_date), '1900-01-01') from {{ this }})
    {% endif %}
),

source_orders as (
    select 
        order_id,
        total_amount
    from {{ source('dwh_raw', 'orders') }}
),

payment_aggregation as (
    select 
        payments.order_id,
        sum(case when payments.amount >= 0 then payments.amount else 0 end) as total_payments
    from source_payments as payments
    group by payments.order_id
),

transformed_payments as (
    select 
        payments.payment_id,
        payments.order_id,
        payments.payment_date::date as payment_date,
        case 
            when upper(payments.payment_method) in ('CARD', 'UPI', 'COD', 'NETBANKING') 
            then upper(payments.payment_method)
            else 'CARD'
        end as payment_method,
        case 
            when payments.amount < 0 then null
            else payments.amount
        end as amount,
        case 
            when orders.total_amount is null then false
            when payment_agg.total_payments >= orders.total_amount then true
            else false
        end as is_fully_applied
    from source_payments as payments
    inner join source_orders as orders
        on payments.order_id = orders.order_id
    left join payment_aggregation as payment_agg
        on payments.order_id = payment_agg.order_id
)

select 
    payment_id,
    order_id,
    payment_date,
    payment_method,
    amount,
    is_fully_applied
from transformed_payments