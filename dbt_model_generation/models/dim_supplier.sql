{#
------------------------------------------------------------------------
MODEL NAME    : dim_supplier
TARGET TABLE  : BSL_MA.DWH_MA.DIM_SUPPLIER
SOURCE TABLES : BSL_RAW.DWH_RAW.SUPPLIERS
DESCRIPTION   : Dimension table for suppliers containing supplier details
                with data quality transformations and standardization
PREREQUISITES : Source table BSL_RAW.DWH_RAW.SUPPLIERS must exist
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-21
------------------------------------------------------------------------
#}

{{ config(
    materialized='table'
) }}

with source_suppliers as (
    select
        suppliers.supplier_id,
        suppliers.supplier_name,
        suppliers.contact_email,
        suppliers.country,
        suppliers.active_flag,
        suppliers.inserted_at -- auto corrected using semantic file
    from {{ source('dwh_raw', 'suppliers') }} as suppliers
),

transformed_suppliers as (
    select
        source_suppliers.supplier_id,
        trim(initcap(source_suppliers.supplier_name)) as supplier_name,
        case 
            when regexp_like(lower(source_suppliers.contact_email), '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
            then lower(source_suppliers.contact_email)
            else null
        end as contact_email,
        upper(source_suppliers.country) as country,
        coalesce(source_suppliers.active_flag, false) as is_active,
        source_suppliers.inserted_at as last_updated
    from source_suppliers
)

select * from transformed_suppliers