{#
------------------------------------------------------------------------
MODEL NAME    : fact_order_item
TARGET TABLE  : BSL_MA.DWH_MA.FACT_ORDER_ITEM
SOURCE TABLES : BSL_RAW.DWH_RAW.ORDER_ITEMS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for order items with 
                calculated extended amounts, discount allocations, and 
                net amounts. Includes data quality checks and lookups.
PREREQUISITES : dim_product and fact_order models must exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='order_item_id'
) }}

with source_order_items as (
    select
        order_item_id,
        order_id,
        product_id,
        quantity,
        unit_price
    from {{ source('dwh_raw', 'order_items') }}
    {% if var('models')['backfill_flag'] == 'true' %}
        where last_updated between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
    {% endif %}
    {% if is_incremental() %}
        where last_updated > (select max(last_updated) from {{ this }})
    {% endif %}
),

source_orders as (
    select
        order_id
    from {{ source('dwh_raw', 'orders') }}
),

-- Validate order_id exists in fact_order
validated_order_items as (
    select
        order_items.order_item_id,
        order_items.order_id,
        order_items.product_id,
        order_items.quantity,
        order_items.unit_price
    from source_order_items as order_items
    inner join {{ ref('fact_order') }} as fact_order
        on order_items.order_id = fact_order.order_id
),

-- Handle product_id lookup and set to 0 if missing
product_validated_items as (
    select
        validated_items.order_item_id,
        validated_items.order_id,
        coalesce(dim_product.product_id, '0') as product_id, -- Auto corrected using semantic file: set to '0' if product missing
        round(validated_items.quantity) as quantity, -- Ensure integer semantics
        validated_items.unit_price
    from validated_order_items as validated_items
    left join {{ ref('dim_product') }} as dim_product
        on validated_items.product_id = dim_product.product_id
),

-- Calculate derived amounts
final_calculations as (
    select
        product_items.order_item_id,
        product_items.order_id,
        product_items.product_id,
        product_items.quantity,
        product_items.unit_price::number(10,2) as unit_price,
        (product_items.quantity * coalesce(product_items.unit_price, 0))::number(12,2) as extended_amount,
        0::number(12,2) as discount_amount, -- Set to 0 as no discount context available
        current_timestamp() as last_updated
    from product_validated_items as product_items
)

select
    final_calc.order_item_id,
    final_calc.order_id,
    final_calc.product_id,
    final_calc.quantity,
    final_calc.unit_price,
    final_calc.extended_amount,
    final_calc.discount_amount,
    greatest((final_calc.extended_amount - final_calc.discount_amount), 0)::number(12,2) as net_amount, -- Ensure non-negative, floor at 0
    final_calc.last_updated
from final_calculations as final_calc