{#
------------------------------------------------------------------------
MODEL NAME    : fact_payment
TARGET TABLE  : BSL_MA.DWH_MA.FACT_PAYMENT
SOURCE TABLES : BSL_RAW.DWH_RAW.PAYMENTS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for payment transactions
                with enhanced business logic including payment method
                standardization and full payment application flags.
PREREQUISITES : Source tables PAYMENTS and ORDERS must be available
PARAMETER     : Incremental materialization based on last_updated
AUTHOUR       : AI Generated by Shajahan - 2025-11-19
------------------------------------------------------------------------
#}

{{ config(materialized='incremental') }}

with source_payments as (
    select 
        payment_id,
        order_id,
        payment_date,
        payment_method,
        amount
    from {{ source('dwh_raw', 'payments') }}
    {% if is_incremental() %}
        where payment_date > (select max(payment_date) from {{ this }})
    {% endif %}
),

source_orders as (
    select 
        order_id,
        total_amount
    from {{ source('dwh_raw', 'orders') }}
),

payment_aggregation as (
    select 
        payments.order_id,
        sum(payments.amount) as total_payments_amount
    from source_payments as payments
    group by payments.order_id
),

transformed_payments as (
    select 
        payments.payment_id,
        payments.order_id,
        payments.payment_date::date as payment_date,
        case 
            when upper(payments.payment_method) in ('CREDIT CARD', 'DEBIT CARD') then 'CARD'
            when upper(payments.payment_method) = 'PAYPAL' then 'UPI'
            when upper(payments.payment_method) in ('UPI', 'COD', 'NETBANKING') then upper(payments.payment_method)
            else 'CARD'
        end as payment_method,
        case 
            when payments.amount < 0 then null
            else payments.amount
        end as amount,
        case 
            when orders.total_amount is null then false
            when payment_agg.total_payments_amount >= orders.total_amount then true
            else false
        end as is_fully_applied,
        current_timestamp() as last_updated
    from source_payments as payments
    inner join source_orders as orders 
        on payments.order_id = orders.order_id
    left join payment_aggregation as payment_agg 
        on payments.order_id = payment_agg.order_id
)

select 
    payment_id,
    order_id,
    payment_date,
    payment_method,
    amount,
    is_fully_applied,
    last_updated
from transformed_payments