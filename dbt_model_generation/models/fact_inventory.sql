{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, stock quantities, and latest record flags
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : None
AUTHOR        : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

with source_inventory as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

inventory_with_latest_flag as (
    select 
        inv.product_id,
        inv.supplier_id,
        -- If negative stock_qty, set to null and flag
        case 
            when inv.stock_qty < 0 then null 
            else inv.stock_qty 
        end as stock_qty,
        -- Uppercase warehouse location
        upper(inv.warehouse_location) as warehouse_location,
        -- Convert timestamp to date
        inv.last_updated::date as snapshot_date,
        -- Flag latest record per product_id+supplier_id by max(last_updated)
        case 
            when inv.last_updated = max(inv.last_updated) over (
                partition by inv.product_id, inv.supplier_id
            ) then true 
            else false 
        end as is_latest
    from source_inventory inv
),

final_inventory as (
    select 
        -- Lookup product_id; If missing set to 0 (unknown) and retain for audit
        coalesce(inv.product_id, '0') as product_id,
        -- Lookup supplier_id; If supplier missing set to 0 (unknown)
        coalesce(inv.supplier_id, '0') as supplier_id,
        inv.stock_qty,
        inv.warehouse_location,
        inv.snapshot_date,
        inv.is_latest,
        current_timestamp() as last_updated -- auto corrected using semantic file
    from inventory_with_latest_flag inv
)

select * from final_inventory