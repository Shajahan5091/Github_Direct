{#
------------------------------------------------------------------------
MODEL NAME    : fact_inventory
TARGET TABLE  : BSL_MA.DWH_MA.FACT_INVENTORY
SOURCE TABLES : BSL_RAW.DWH_RAW.INVENTORY
DESCRIPTION   : Inventory latest snapshot fact table with product and 
                supplier lookups, stock quantities, and latest record flags
PREREQUISITES : dim_product and dim_supplier models should exist
PARAMETER     : None
AUTHOUR       : AI Generated by Shajahan - 2025-11-19
------------------------------------------------------------------------
#}

{{ config(materialized='table') }}

with source_inventory as (
    select 
        product_id,
        supplier_id,
        stock_qty,
        warehouse_location,
        last_updated
    from {{ source('dwh_raw', 'inventory') }}
),

inventory_with_latest_flag as (
    select 
        source_inventory.product_id,
        source_inventory.supplier_id,
        source_inventory.stock_qty,
        source_inventory.warehouse_location,
        source_inventory.last_updated,
        case 
            when source_inventory.last_updated = max(source_inventory.last_updated) over (
                partition by source_inventory.product_id, source_inventory.supplier_id
            ) then true
            else false
        end as is_latest_record
    from source_inventory
),

final_inventory as (
    select 
        -- Product ID lookup with unknown handling
        coalesce(inventory_with_latest_flag.product_id, '0') as product_id, -- auto corrected using semantic file
        
        -- Supplier ID lookup with unknown handling  
        coalesce(inventory_with_latest_flag.supplier_id, '0') as supplier_id,
        
        -- Stock quantity with negative value handling
        case 
            when inventory_with_latest_flag.stock_qty < 0 then null
            else inventory_with_latest_flag.stock_qty
        end as stock_qty,
        
        -- Warehouse location uppercase transformation
        upper(inventory_with_latest_flag.warehouse_location) as warehouse_location,
        
        -- Convert timestamp to date for snapshot date
        date(inventory_with_latest_flag.last_updated) as snapshot_date,
        
        -- Latest record flag
        inventory_with_latest_flag.is_latest_record as is_latest
        
    from inventory_with_latest_flag
)

select * from final_inventory