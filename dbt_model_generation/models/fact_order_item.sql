{#
------------------------------------------------------------------------
MODEL NAME    : fact_order_item
TARGET TABLE  : BSL_MA.DWH_MA.FACT_ORDER_ITEM
SOURCE TABLES : BSL_RAW.DWH_RAW.ORDER_ITEMS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for order items with 
                calculated extended amounts, discount allocations, and 
                net amounts. Includes data quality checks and lookups.
PREREQUISITES : dim_product and fact_order models must exist
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-21
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental',
    unique_key='order_item_id'
) }}

with source_order_items as (
    select 
        order_item_id,
        order_id,
        product_id,
        quantity,
        unit_price,
        inserted_at
    from {{ source('dwh_raw', 'order_items') }}
    {% if var('models')['backfill_flag'] == 'true' %}
        where inserted_at between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
    {% endif %}
    {% if is_incremental() %}
        and inserted_at > (select max(inserted_at) from {{ this }})
    {% endif %}
),

source_orders as (
    select 
        order_id
    from {{ source('dwh_raw', 'orders') }}
),

-- Validate order_id exists in fact_order
validated_order_items as (
    select 
        oi.order_item_id,
        oi.order_id,
        oi.product_id,
        oi.quantity,
        oi.unit_price,
        oi.inserted_at
    from source_order_items oi
    inner join {{ ref('fact_order') }} fo 
        on oi.order_id = fo.order_id
),

-- Handle product_id lookup and set to 0 if missing
product_validated_items as (
    select 
        voi.order_item_id,
        voi.order_id,
        coalesce(dp.product_id, '0') as product_id, -- auto corrected using semantic file: set to '0' if product missing
        voi.quantity,
        voi.unit_price,
        voi.inserted_at
    from validated_order_items voi
    left join {{ ref('dim_product') }} dp 
        on voi.product_id = dp.product_id
),

-- Calculate extended amount and other derived fields
final_calculations as (
    select 
        pvi.order_item_id,
        pvi.order_id,
        pvi.product_id,
        round(pvi.quantity) as quantity, -- Ensure integer semantics; round if fractional
        pvi.unit_price,
        round(pvi.quantity) * coalesce(pvi.unit_price, 0) as extended_amount, -- If unit_price null treat as 0
        0.00 as discount_amount, -- Set 0 if no discount context
        pvi.inserted_at
    from product_validated_items pvi
),

final as (
    select 
        fc.order_item_id,
        fc.order_id,
        fc.product_id,
        fc.quantity,
        fc.unit_price,
        fc.extended_amount,
        fc.discount_amount,
        greatest(fc.extended_amount - fc.discount_amount, 0) as net_amount, -- Ensure non-negative; floor at 0
        fc.inserted_at as last_updated,
        current_timestamp() as last_updated_timestamp
    from final_calculations fc
)

select * from final