{#
------------------------------------------------------------------------
MODEL NAME    : fact_payment
TARGET TABLE  : BSL_MA.DWH_MA.FACT_PAYMENT
SOURCE TABLES : BSL_RAW.DWH_RAW.PAYMENTS, BSL_RAW.DWH_RAW.ORDERS
DESCRIPTION   : This model creates a fact table for payment transactions
                with enriched data including payment validation and order
                total comparison to determine if payments are fully applied.
PREREQUISITES : fact_order model should be available for order lookups
PARAMETER     : backfill_flag, backfill_start_date, backfill_end_date
AUTHOUR       : AI Generated by Shajahan - 2025-11-20
------------------------------------------------------------------------
#}

{{ config(
    materialized='incremental'
) }}

with source_payments as (
    select
        payment_id,
        order_id,
        payment_date,
        payment_method,
        amount
    from {{ source('dwh_raw', 'payments') }}
),

source_orders as (
    select
        order_id,
        total_amount
    from {{ source('dwh_raw', 'orders') }}
),

-- Transform payment data with business logic
transformed_payments as (
    select
        payments.payment_id,
        payments.order_id,
        payments.payment_date::date as payment_date,
        case 
            when upper(payments.payment_method) in ('CREDIT CARD', 'DEBIT CARD') then 'CARD'
            when upper(payments.payment_method) = 'PAYPAL' then 'UPI'
            when upper(payments.payment_method) in ('CARD', 'UPI', 'COD', 'NETBANKING') then upper(payments.payment_method)
            else 'CARD'
        end as payment_method,
        case 
            when payments.amount < 0 then null
            else payments.amount
        end as amount,
        orders.total_amount as order_total_amount
    from source_payments as payments
    inner join source_orders as orders
        on payments.order_id = orders.order_id
),

-- Calculate payment aggregations per order
payment_aggregations as (
    select
        order_id,
        sum(amount) as total_payments
    from transformed_payments
    where amount is not null
    group by order_id
),

-- Final model with is_fully_applied logic
final_payments as (
    select
        transformed_payments.payment_id,
        transformed_payments.order_id,
        transformed_payments.payment_date,
        transformed_payments.payment_method,
        transformed_payments.amount,
        case 
            when transformed_payments.order_total_amount is null then false
            when payment_aggregations.total_payments >= transformed_payments.order_total_amount then true
            else false
        end as is_fully_applied,
        current_timestamp() as last_updated
    from transformed_payments
    left join payment_aggregations
        on transformed_payments.order_id = payment_aggregations.order_id
)

select * from final_payments

{% if var('models')['backfill_flag'] == 'true' %}
where last_updated between '{{ var("models")["backfill_start_date"] }}' and '{{ var("models")["backfill_end_date"] }}'
{% endif %}

{% if is_incremental() %}
where last_updated > (select max(last_updated) from {{ this }})
{% endif %}